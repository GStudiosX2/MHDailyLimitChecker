<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Minehut Server Daily Limit Checker</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
		<script src="https://cdn.tailwindcss.com"></script>
		
		<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/duration.js"></script>
		
		<script>
			dayjs.extend(window.dayjs_plugin_utc);
			dayjs.extend(window.dayjs_plugin_relativeTime);
			dayjs.extend(window.dayjs_plugin_timezone);
			dayjs.extend(window.dayjs_plugin_duration);
			
			dayjs.tz.guess();
		</script>
	</head>
	<body class="bg-zinc-900 h-[100dvh] h-screen text-zinc-200 font-sans">
		<noscript>
			<strong>This page does not work without javascript enabled.</strong>
		</noscript>
		
		<div class="flex justify-center items-center w-full h-full">
			<div class="p-4 bg-zinc-800 flex flex-col gap-2 rounded-md w-full h-full justify-center md:justify-start md:h-auto md:w-1/2 xl:w-1/3">
				<span class="font-bold text-2xl">Minehut Server Daily Limit Checker</span>
				<span class="border-l-4 border-yellow-700 px-4 mt-2 italic">
					<span class="font-bold">WARNING!</span> This is not by Minehut/SLE/SLG. I am not affialted with Minehut/SLE/SLG although this does use the Minehut API, it may not be totally accurate and I do not know when the API updates it's info.
				</span>
				
				<span class="border-l-4 border-red-700 px-4 mt-2 italic">
					Also, this can break anytime if they change their API or anything so you can't really rely on this but i'll try and keep it working.
				</span>
				
				<span class="py-2">
					This let's you check how much time left you can play on your server, since Minehut added a daily time limit for free plans.
				</span>
				
				<div class="py-2 flex justify-center">
					<span id="timeLeft" class="flex flex-wrap gap-1 text-lg text-center">
						Press Check After Inputting A Server Name
					</span>
				</div>
				
				<form id="form" class="flex flex-col gap-2 w-full">
					<input id="server-name" name="serverName" class="px-4 py-2 bg-[#5d626e] rounded-md outline-none border-2 border-transparent focus-within:border-white focus-within:border-opacity-75 box-border" placeholder="Enter Server Name" autocomplete="off" />
					
					<button type="submit" id="check-time-btn" class="px-4 py-2 bg-[#488aff] rounded-md outline-none border-2 border-transparent focus-within:border-white focus-within:border-opacity-75 box-border">Check</button>
				</form>
			</div>
		</div>
		
		<script>
			const API_URL = 'https://api.minehut.com';
			const msDaily = 14400 * 1000;
			const searchParams = new URL(document.location).searchParams;
			
			const serverNameInput = document.getElementById('server-name');
			const checkTimeBtn = document.getElementById('check-time-btn');
			const timeLeft = document.getElementById('timeLeft');
			
			document.getElementById('form').addEventListener('submit', (e) => {
				e.preventDefault();
				checkTimeLeft();
			});
			
			async function sendRequest() {
				if ((window.location.origin === 'file://' || window.location.hostname.includes('localhost')) && 
					searchParams.get('localhostSendRequest') === null) { // for testing purposes
					const dayTime = dayjs(new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" })));
					return { // all required fields
						"server_plan": "FREE",
						"daily_online_time": {
							[`${dayTime.date()}-${dayTime.month()}-${dayTime.year()}`]: searchParams.get('localhostDailyOnlineTime') * 1000 || msDaily
						}
					};
				} else {
					return (await fetch(`${API_URL}/server/${serverNameInput.value}?byName=true`)
						.then((res) => res.json()))['server'];
				}
			}
			
			async function checkTimeLeft() {
				if (checkTimeBtn.textContent === '...') {
					return;
				}
				
				if (serverNameInput.value.trim() === '' || serverNameInput.value.length === 0) {
					timeLeft.classList.add('text-red-500');
					timeLeft.textContent = 'You must enter a server name!';
					return;
				}
				
				timeLeft.classList.remove('text-red-500');
				checkTimeBtn.textContent = '...';
				
				try {
					const req = await sendRequest();
						
					const time = new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" })); //convert to PST
					const dayTime = dayjs(time);
					
					const formatted = `${dayTime.date()}-${dayTime.month()}-${dayTime.year()}`;
					if (req['server_plan'] === 'FREE') {
						const ms = req['daily_online_time'][formatted] ?? 0;
						
						let duration = dayjs.duration(msDaily - ms);
						if ((msDaily - ms) <= 0) {
							let oneAMPSTReset = dayjs().utc().startOf('day').add(8, 'hour').tz();
							if (oneAMPSTReset.isBefore(dayjs())) 
								oneAMPSTReset = oneAMPSTReset.add(1, 'day');
							duration = null;
								
							timeLeft.innerHTML = `<span class="font-bold">${serverNameInput.value}'s</span> daily time limit has run out. Daily limit resets at 
							<pre><code class="p-1 px-2 bg-zinc-700 rounded-sm">1 AM PST</code></pre> 
							that would be 
							<pre><code class="p-1 px-2 bg-zinc-700 rounded-sm" title="${oneAMPSTReset.format('hh:mm')}">${dayjs.duration(oneAMPSTReset.diff(dayjs())).humanize(true)}</code></pre> in your timezone.`;
						}
						
						if (duration) {
							timeLeft.innerHTML = `<span class="font-bold">${serverNameInput.value}</span> has ${("" + duration.hours()).padStart(2, '0')}h ${("" + duration.minutes()).padStart(2, '0')}m ${("" + duration.seconds()).padStart(2, '0')}s left.`;
						}
					} else {
						timeLeft.textContent = 'The daily limit only applies to FREE servers.';
					}
				} catch (e) {
					console.log(e);
					timeLeft.classList.add('text-red-500');
					timeLeft.textContent = 'Invalid server name!';
				}
				
				checkTimeBtn.textContent = 'Check';
				serverNameInput.value = '';
			}
		</script>
	</body>
</html>